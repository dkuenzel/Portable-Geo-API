<html>

	<head>
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
   integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
   crossorigin=""/>
   	<script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
   integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
   crossorigin=""></script>
   	
   	<style>
			div {
				margin: 10px;
			}
   		#mapid {
   			height: 25%;
   		}
   		.coordinate-input-field {
   			width: 150px;
   		}
   		.short-number-input {
   			width: 40px;
   		}
   	</style>
   	
   	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>

   	
	</head>

	<body>
		<div id="header">	
		<h1>API documentation and Sandbox</h1>
		<hr>
		</div>
		
	
		<div id="mapid"></div>
		
		<div id="input">
		
			<label for="query-builder-div">Build your request:</label>
			<br>
			<input type="button" value="use browser location as origin" id="browser-location-as-origin">
			<input type="button" value="pick origin from map" id="origin-location-from-map">
			<input type="button" value="pick destination from map" id="destination-location-from-map">
			
			<div id="query-builder-container">
				<span id="general-options" class="ich-option p2p-option">
					<input type="text" id="base-url">
					<i>/</i>
					<select id="api-function-select">
						<option>p2p</option>
						<option>ich</option>
					</select>
					<i>/</i>
					<select id="output-format-select">
						<option>0</option>
						<option>1</option>
						<option>2</option>
						<option>3</option>
					</select>
					<i>/</i>
				</span>
				<span id="range-options" class="ich-option">
					<input type="text" id="range-field" placeholder="range" class="short-number-input">
					<i>/</i>
				</span>
				<span id="origin-coordinates" class="p2p-option ich-option">
					<input type="text" id="origin-longitude-field" class="coordinate-input-field" placeholder="origin longitude">
					<i>/</i>
					<input type="text" id="origin-latitude-field" class="coordinate-input-field" placeholder="origin latitude">
				</span>
				<span id="destination-coordinates" class="p2p-option">
					<i>/</i>
					<input type="text" id="destination-longitude-field" class="coordinate-input-field" placeholder="destination longitude">
					<i>/</i>
					<input type="text" id="destination-latitude-field" class="coordinate-input-field" placeholder="destination latitude">
				</span>
			</div>
			<input type="button" value="send request" id="send-request-button">
			
		</div>
		
		<div id="help">
			<div id="p2p-doc" class="documentation-text">
				<h3>Peer to Peer (<i>p2p</i>) requests</h3>
				Request format: "http://host:port/p2p/integer:outputFormat/float:origin_lon/float:origin_lat/float:destination_lon/float:destination_lat"<br>
				outputFormat:
				<ul>
					<li>0 = Beautified (HTML)
					<li>1 = Raw output (JSON)
					<li>2 = Distance only
					<li>3 = Route only (returned as array of wkt elements with EPSG 4326)
				</ul>
			</div>
			<div id="ich-doc" class="documentation-text">
				<h3>Isochrone requests (<i>ich</i>) requests</h3>
				Request format: "http://host:port/ich/integer:outputFormat/float:maxRange/float:origin_lon/float:origin_lat"<br>
				maxRange: distance in hours<br>
				outputFormat:
				<ul>
					<li>0 = Beautified (HTML)
					<li>1 = Raw output (JSON)
					<li>2 = Nodes only (JSON)
					<li>3 = Geometry only (returned as WKT element with EPSG 4326)
				</ul>
			</div>
		</div>
		
	  	<script>
			var map = L.map('mapid').setView([51.505, -0.09], 13);

			L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
				maxZoom: 18,
				attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
					'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
					'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
				id: 'mapbox.streets'
			}).addTo(map);
		</script>
		
		<hr>
		
		<div id="notification-area"></div>
		<div id="result-area"></div>
		
		<script>
			// Get base API URL
			var baseUrl = window.location.origin
			// Container for the map markers 
			var markers = {}
			
			// Browser coordinates
			var x = document.getElementById("notification-area");
			function getLocation() {
				if (navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(showPosition);
				} else {
					x.innerHTML = "Geolocation is not supported by this browser.";
				}
			}

			function showPosition(position) {
				browserGeocode = {"longitude": position.coords.longitude, "latitude": position.coords.latitude}
				addBrowserLocationAsOrigin(browserGeocode)
			}
			
			function addBrowserLocationAsOrigin (browserGeocode) {
				longitude = browserGeocode.longitude
				latitude = browserGeocode.latitude
				$("#origin-longitude-field").val(longitude)
				$("#origin-latitude-field").val(latitude)
				map.flyTo([latitude, longitude], 13)
				if (markers["origin"]) { map.removeLayer(markers["origin"]); }
				if (markers["browser"]) { map.removeLayer(markers["browser"]); }
				markers["browser"] = L.marker([latitude, longitude])
				markers["browser"].addTo(map).bindPopup('Your Browser Location (Maybe highly inaccurate)').openPopup();
			}
			
			// Coordinates from map
			var field = ""
			function getCoordsFromMap (e) {
				coord = e.latlng;
				var latitude = coord.lat;
				var longitude = coord.lng;
				$("#" + field + "-longitude-field").val(longitude)
				$("#" + field + "-latitude-field").val(latitude)
				if (markers[field]) { map.removeLayer(markers[field]); }
				markers[field] = L.marker([latitude, longitude])
				markers[field].addTo(map).bindPopup('Your ' + field + ' location').openPopup();
				deactivateCoordsFromMap();
			}
			function activateCoordsFromMap (e) {
				field = e
				map.on('click', function(e){ getCoordsFromMap(e) });
			}
			function deactivateCoordsFromMap () { 
				map.off('click', function(e){ getCoordsFromMap(e) });
			}
			
			// Send request
			//TODO: Send Request and display results on map + output-area field
			function sendRequest() {
				apiFunction = $("#api-function-select").val()
				if (apiFunction == "p2p") {
					requestString = $("#base-url").val() + "/" + $("#api-function-select").val() + "/" + $("#output-format-select").val() + "/" + $("#origin-longitude-field").val() + "/" + $("#origin-latitude-field").val() + "/" + $("#destination-longitude-field").val() + "/" + $("#destination-latitude-field").val()
				}
				if (apiFunction == "ich") {
					requestString = $("#base-url").val() + "/" + $("#api-function-select").val() + "/" + $("#output-format-select").val() + "/" + $("#range-field").val() + "/" + $("#origin-longitude-field").val() + "/" + $("#origin-latitude-field").val()
				}
				$("#result-area").text(requestString)
			}
			
			// Listeners and stuff
			$(document).ready( function () {
				// Set base url in query builder
				$("#base-url").val(baseUrl)
				// Buttons
				$("#browser-location-as-origin").on( "click", function( event ) {  getLocation(); });
				$("#origin-location-from-map").on( "click", function( event ) {  if (markers["browser"]) { map.removeLayer(markers["browser"]); }; activateCoordsFromMap("origin"); });
				$("#destination-location-from-map").on( "click", function( event ) {  activateCoordsFromMap("destination"); });
				$("#send-request-button").on("click", function( event ) { sendRequest() })
				
				// Query builder listeners
				$("#api-function-select").on( "change", function( event ) {  
					if ($("#api-function-select").val() == "p2p") {
						$(".documentation-text").hide()
						$("#p2p-doc").show()
						$("#query-builder-container span").hide()
						$("#destination-location-from-map").show()
						$(".p2p-option").show()
					}
					else if ($("#api-function-select").val() == "ich") {
						$(".documentation-text").hide()
						$("#ich-doc").show()
						$("#query-builder-container span").hide()
						$("#destination-location-from-map").hide()
						$(".ich-option").show()
					}
				});
				$("#api-function-select").change()  // Update view
			});
			
		</script>

	</body>
	
	

</html>
