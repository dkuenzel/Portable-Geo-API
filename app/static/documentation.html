<html>

	<head>
		<!-- Styles -->
   	<style>
			div {
				margin-top: 10px;
			}
   		#mapid {
   			height: 40%;
   		}
   		.coordinate-input-field {
   			width: 150px;
   		}
   		.short-number-input {
   			width: 40px;
   		}
   	</style>
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
   integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
   crossorigin=""/>
		<link rel="stylesheet" type="text/css" href="/static/vendor/accordion.css">
   
		<!-- Scripts -->
   	<script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
   integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
   crossorigin=""></script>
   	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
   	<script src="/static/vendor/wicket.js" type="text/javascript"></script>
		<script src="/static/vendor/wicket-leaflet.js" type="text/javascript"></script>
		<script src="/static/vendor/accordion.js" type="text/javascript"></script>
   	
	</head>

	<body>
		<div id="header">	
		<h1>API documentation and Sandbox</h1>
		<hr>
		</div>
		
	
		<div id="mapid"></div>
		
		<div id="input">
		
			<label for="query-builder-div">Build your request:</label>
			<br>
			<input type="button" value="use browser location as origin" id="browser-location-as-origin">
			<input type="button" value="pick origin from map" id="origin-location-from-map">
			<input type="button" value="pick destination from map" id="destination-location-from-map">
			
			<div id="query-builder-container">
				<span id="general-options" class="ich-option p2p-option">
					<input type="text" id="base-url">
					<i>/</i>
					<select id="api-function-select">
						<option>p2p</option>
						<option>ich</option>
					</select>
					<i>/</i>
					<select id="output-format-select">
						<option>0</option>
						<option>1</option>
						<option>2</option>
						<option selected>3</option>
					</select>
					<i>/</i>
				</span>
				<span id="range-options" class="ich-option">
					<input type="number" id="range-field" placeholder="range (h)" value=0.5 class="short-number-input">
					<i>/</i>
				</span>
				<span id="origin-coordinates" class="p2p-option ich-option">
					<input type="number" id="origin-longitude-field" class="coordinate-input-field" placeholder="origin longitude" value=6.750411987304688>
					<i>/</i>
					<input type="number" id="origin-latitude-field" class="coordinate-input-field" placeholder="origin latitude" value=51.208549699452>
				</span>
				<span id="destination-coordinates" class="p2p-option">
					<i>/</i>
					<input type="number" id="destination-longitude-field" class="coordinate-input-field" placeholder="destination longitude" value=6.781139373779297>
					<i>/</i>
					<input type="number" id="destination-latitude-field" class="coordinate-input-field" placeholder="destination latitude" value=51.20876513645167>
				</span>
			</div>
			<input type="button" value="send request" id="send-request-button">
			
		</div>
		
		<hr>
		
		<div id="ss_menu">
			<div id="help">
				<div class="ss_button">Help</div>
				<div class="ss_content">
					<div id="p2p-doc" class="documentation-text">
						<h3>Peer to Peer (<i>p2p</i>) requests</h3>
						Request format: "http://host:port/p2p/integer:outputFormat/float:origin_lon/float:origin_lat/float:destination_lon/float:destination_lat"<br>
						outputFormat:
						<ul>
							<li>0 = Beautified (HTML)
							<li>1 = Raw output (JSON)
							<li>2 = Distance only
							<li>3 = Route only (returned as array of wkt elements with EPSG 4326)
						</ul>
					</div>
					<div id="ich-doc" class="documentation-text">
						<h3>Isochrone requests (<i>ich</i>) requests</h3>
						Request format: "http://host:port/ich/integer:outputFormat/float:maxRange/float:origin_lon/float:origin_lat"<br>
						maxRange: distance in hours<br>
						outputFormat:
						<ul>
							<li>0 = Beautified (HTML)
							<li>1 = Raw output (JSON)
							<li>2 = Nodes only (JSON)
							<li>3 = Geometry only (returned as WKT element with EPSG 4326)
						</ul>
					</div>
				</div>
			</div>
		</div>
		
	  	<script>
			var map = L.map('mapid').setView([51.21358759080191, 6.7471182346344], 13);

			L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
				maxZoom: 18,
				attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
					'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
					'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
				id: 'mapbox.streets'
			}).addTo(map);
		</script>
		
		<div id="notification-area"></div>
		<div id="result-area"></div>
		
		<script>
			// Get base API URL
			var baseUrl = window.location.origin
			
			// Container for the map mapFeatureDict 
			var mapFeatureDict = {}
			
			// Browser coordinates
			var x = document.getElementById("notification-area");
			function getLocation() {
				if (navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(showPosition);
				} else {
					x.innerHTML = "Geolocation is not supported by this browser.";
				}
			}

			function showPosition(position) {
				browserGeocode = {"longitude": position.coords.longitude, "latitude": position.coords.latitude}
				addBrowserLocationAsOrigin(browserGeocode)
			}
			
			function addBrowserLocationAsOrigin (browserGeocode) {
				longitude = browserGeocode.longitude
				latitude = browserGeocode.latitude
				$("#origin-longitude-field").val(longitude)
				$("#origin-latitude-field").val(latitude)
				map.flyTo([latitude, longitude], 13)
				if (mapFeatureDict["origin"]) { map.removeLayer(mapFeatureDict["origin"]); }
				if (mapFeatureDict["browser"]) { map.removeLayer(mapFeatureDict["browser"]); }
				mapFeatureDict["browser"] = L.marker([latitude, longitude])
				mapFeatureDict["browser"].addTo(map).bindPopup('Your Browser Location (Maybe highly inaccurate)').openPopup();
			}
			
			// Coordinates from map
			var field = ""
			function getCoordsFromMap (e) {
				coord = e.latlng;
				var latitude = coord.lat;
				var longitude = coord.lng;
				$("#" + field + "-longitude-field").val(longitude)
				$("#" + field + "-latitude-field").val(latitude)
				if (mapFeatureDict[field]) { map.removeLayer(mapFeatureDict[field]); }
				mapFeatureDict[field] = L.marker([latitude, longitude])
				mapFeatureDict[field].addTo(map).bindPopup('Your ' + field + ' location').openPopup();
				deactivateCoordsFromMap();
			}
			function activateCoordsFromMap (e) {
				field = e
				map.on('click', function(e){ getCoordsFromMap(e) });
			}
			function deactivateCoordsFromMap () { 
				map.off('click', function(e){ getCoordsFromMap(e) });
			}
			
			// Build request from input fields
			function buildRequest() {
				apiFunction = $("#api-function-select").val()
				if (apiFunction == "p2p") {
					requestString = $("#base-url").val() + "/" + $("#api-function-select").val() + "/" + $("#output-format-select").val() + "/" + $("#origin-longitude-field").val() + "/" + $("#origin-latitude-field").val() + "/" + $("#destination-longitude-field").val() + "/" + $("#destination-latitude-field").val()
				}
				if (apiFunction == "ich") {
					requestString = $("#base-url").val() + "/" + $("#api-function-select").val() + "/" + $("#output-format-select").val() + "/" + $("#range-field").val() + "/" + $("#origin-longitude-field").val() + "/" + $("#origin-latitude-field").val()
				}
				$("#notification-area").text(requestString)
				
				return requestString
			}
			
			// Ajax request
			function sendRequest() {
				request = buildRequest()
				$("#result-area").text("loading data...");
				$.ajax({
					url: request,
					cache: false
				})
					.done(function(result) {
						if ($("#output-format-select").val() == 0) {$("#result-area").html(result)}  // Beautified output
						if ($("#output-format-select").val() == 1 || $("#output-format-select").val() == 2) {  // JSON output
							result = JSON.stringify(result, null, '\t');
							$("#result-area").text(result)
						}
						if ($("#output-format-select").val() == 3) {  // Map output
							$("#result-area").text(result)
							// Remove old layer from map
							if (mapFeatureDict["result"]) {
								for (i in mapFeatureDict["result"]){
									map.removeLayer(mapFeatureDict["result"][i]);
								}
							}
							else {
								mapFeatureDict["result"] = []
							}
							// Draw new layer on map
							var wicket = new Wkt.Wkt();
							for (i in result){
								wktGeom = result[i]
								wicket.read(wktGeom);
								var feature = wicket.toObject();
								mapFeatureDict["result"][i] = feature;
								console.log(wktGeom)
								mapFeatureDict["result"][i].addTo(map);
							}
						}
					});
				}
			

			
			// Listeners and stuff
			$(document).ready( function () {
				// Set base url in query builder
				$("#base-url").val(baseUrl)
				// Buttons
				$("#browser-location-as-origin").on( "click", function( event ) {  getLocation(); });
				$("#origin-location-from-map").on( "click", function( event ) {  if (mapFeatureDict["browser"]) { map.removeLayer(mapFeatureDict["browser"]); }; activateCoordsFromMap("origin"); });
				$("#destination-location-from-map").on( "click", function( event ) {  activateCoordsFromMap("destination"); });
				$("#send-request-button").on("click", function( event ) { sendRequest() })
				
				// Query builder listeners
				$("#api-function-select").on( "change", function( event ) {  
					if ($("#api-function-select").val() == "p2p") {
						$(".documentation-text").hide()
						$("#p2p-doc").show()
						$("#query-builder-container span").hide()
						$("#destination-location-from-map").show()
						$(".p2p-option").show()
					}
					else if ($("#api-function-select").val() == "ich") {
						$(".documentation-text").hide()
						$("#ich-doc").show()
						$("#query-builder-container span").hide()
						$("#destination-location-from-map").hide()
						$(".ich-option").show()
					}
				});
				$("#api-function-select").change()  // Update view
			});
			
		</script>

	</body>
	
	

</html>
